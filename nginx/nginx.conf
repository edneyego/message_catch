events {
    worker_connections 1024;
}

http {
    # Upstreams
    upstream noaa_api {
        server noaa_catch:8000;
    }

    upstream ana_catch_api {
        server ana_catch:8003;
    }

    upstream data_forecast_api {
        server data_forecast_api:8002;
    }

    upstream gage_manager {
        server gage_manager:8004;
    }

    upstream data_drought {
        server data_drought:8005;
    }

    upstream report_alert {
        server report_alert-report-alert-1:8001;
    }

    upstream noaa_ui {
        server noaa_ui:8501;
    }

    upstream ana_ui {
        server ana_ui:8501;
    }

    upstream data_forecast_ui {
        server data_forecast_ui:8501;
    }

    upstream station_manager_ui {
        server station_manager_ui:8501;
    }

    upstream kafdrop {
        server message_catch-kafdrop-1:9000;
    }

    server {
        listen 80;
        server_name _;

        # NOAA API
        location /api/noaa/ {
            rewrite ^/api/noaa/(.*) /noaa_catch/$1 break;
            proxy_pass http://noaa_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api/noaa;
            
            # Reescreve URLs no HTML/JSON de resposta
            sub_filter '"/noaa_catch/' '"/api/noaa/';
            sub_filter "'"/noaa_catch/" "'"/api/noaa/";
            sub_filter "url: '/noaa_catch/" "url: '/api/noaa/";
            sub_filter_once off;
            sub_filter_types application/json text/html;
        }

        # ANA API
        location /api/ana/ {
            rewrite ^/api/ana/(.*) /ana_catch/$1 break;
            proxy_pass http://ana_catch_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api/ana;
            
            # Reescreve URLs no HTML/JSON de resposta
            sub_filter '"/ana_catch/' '"/api/ana/';
            sub_filter "'"/ana_catch/" "'"/api/ana/";
            sub_filter "url: '/ana_catch/" "url: '/api/ana/";
            sub_filter_once off;
            sub_filter_types application/json text/html;
        }

        # Forecast API
        location /api/forecast/ {
            rewrite ^/api/forecast/(.*) /data_forecast/$1 break;
            proxy_pass http://data_forecast_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Prefix /api/forecast;
            
            # Reescreve URLs no HTML/JSON de resposta
            sub_filter '"/data_forecast/' '"/api/forecast/';
            sub_filter "'"/data_forecast/" "'"/api/forecast/";
            sub_filter "url: '/data_forecast/" "url: '/api/forecast/";
            sub_filter_once off;
            sub_filter_types application/json text/html;
        }

        # Gage Manager
        location /api/gage/ {
            rewrite ^/api/gage/(.*) /$1 break;
            proxy_pass http://gage_manager;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Drought API
        location /api/drought/ {
            rewrite ^/api/drought/(.*) /$1 break;
            proxy_pass http://data_drought;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Alert API
        location /api/alert/ {
            rewrite ^/api/alert/(.*) /$1 break;
            proxy_pass http://report_alert;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # UIs Streamlit
        location /noaa/ {
            rewrite ^/noaa/(.*) /$1 break;
            proxy_pass http://noaa_ui;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        location /ana/ {
            rewrite ^/ana/(.*) /$1 break;
            proxy_pass http://ana_ui;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        location /forecast/ {
            rewrite ^/forecast/(.*) /$1 break;
            proxy_pass http://data_forecast_ui;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        location /station/ {
            rewrite ^/station/(.*) /$1 break;
            proxy_pass http://station_manager_ui;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;
        }

        # Kafdrop
        location /kafdrop/ {
            proxy_pass http://kafdrop/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # P√°gina inicial
        location = / {
            return 200 '<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Servi√ßos Dispon√≠veis</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
h1 { color: #333; }
h2 { color: #666; margin-top: 30px; }
ul { list-style: none; padding: 0; }
li { margin: 10px 0; }
a { color: #0066cc; text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
</head>
<body>
<h1>üåä Servi√ßos de Monitoramento H√≠drico</h1>

<h2>üìä APIs</h2>
<ul>
<li><a href="/api/noaa/docs">NOAA API</a> - Dados meteorol√≥gicos NOAA</li>
<li><a href="/api/ana/docs">ANA API</a> - Dados da Ag√™ncia Nacional de √Åguas</li>
<li><a href="/api/forecast/docs">Forecast API</a> - Previs√µes hidrol√≥gicas</li>
<li><a href="/api/gage/docs">Gage Manager API</a> - Gerenciamento de esta√ß√µes</li>
<li><a href="/api/drought/docs">Drought API</a> - Monitoramento de secas</li>
<li><a href="/api/alert/docs">Alert API</a> - Sistema de alertas</li>
</ul>

<h2>üñ•Ô∏è Interfaces Web</h2>
<ul>
<li><a href="/noaa/">NOAA Dashboard</a> - Interface NOAA</li>
<li><a href="/ana/">ANA Dashboard</a> - Interface ANA</li>
<li><a href="/forecast/">Forecast Dashboard</a> - Previs√µes</li>
<li><a href="/station/">Station Manager</a> - Gerenciamento de esta√ß√µes</li>
</ul>

<h2>üîß Ferramentas</h2>
<ul>
<li><a href="/kafdrop/">Kafdrop</a> - Monitoramento Kafka</li>
</ul>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}
